/*
 GPub: A Go publishing platform, built on Glift

 @copyright Josh Hoak
 @license MIT License (see LICENSE.txt)
 --------------------------------------
*/
(function(a){var c=c||a.gpub||{};a&&(a.gpub=c)})(window);gpub.global={version:"0.1.0"};gpub.book={};
gpub.book.manager={toBook:function(a,c){var b=[],d=glift.enums.showVariations.NEVER,f=gpub.diagrams.gooe,e=gpub.diagrams.latex,g=gpub.book.manager,h=a.bookData;b.push(e.basicHeader());b.push(f.gooeDefs());b.push(e.generateTitleDef(h.title,h.subtitle,h.authors,h.publisher));b.push("");b.push(e.diagramLabelMacros());b.push(e.startDocument());a.prepopulateCache(function(){for(var f=h.diagramsPerPage,m=1,r=1,s=1,l=0,t=a.sgfList.length;l<t;l++){var n=a.getSgfObj(l),u=n.boardRegion,p=glift.rules.treepath.parseInitPosition(n.initialPosition),
q=[];a.getSgfString(n,function(a){var c=glift.rules.movetree.getFromSgf(a.sgfString,p),e=c.onMainline();e?s++:r++;if(h.autoNumber){var k=glift.rules.treepath.findNextMovesPath(c),c=k.movetree;p=k.treepath;q=k.nextMoves}var k=glift.rules.goban.getFromMoveTree(c).goban,l=e?c.node().getNodeNum()+1:1,c=glift.bridge.flattener.flatten(c,k,u,d,q,l),k="";a.bookData.showDiagram&&(k=g.createDiagram(c,a.bookData));e=g.typesetDiagram(k,c.comment,a.bookData,c.collisions,e);!a.bookData.chapterTitle&&m<f?(b.push("\\newpage"),
m++):m=1;b.push(e)})}b.push(e.basicFooter);c(b.join("\n"))})},createDiagram:function(a,c){var b=gpub.diagrams.gooe,d=gpub.diagrams.diagramSize.NORMAL;c.chapterTitle&&(d=gpub.diagrams.diagramSize.LARGE);d=b.diagramArray(a,d);return b.diagramArrToString(d)},typesetDiagram:function(a,c,b,d,f){var e=gpub.diagrams.latex,g="";if(b.diagramType===gpub.diagrams.diagramTypes.GAME_REVIEW)return b.showDiagram&&(g=f?"\\gofigure":"\\godiagram",d=e.labelForCollisions(d),0<d.length&&(g+="\n\n \\subtext{"+d+"}")),
b.chapterTitle?e.gameReviewChapterDiagram(a,c,b.chapterTitle,g):e.gameReviewDiagram(a,c,g)}};gpub.gen={};
gpub.gen.collection={fromGames:function(a){for(var c={divId:null,sgfCollection:[],sgfMapping:{}},b=0;a&&b<a.length;b++){var d=a[b],f=glift.sgf.parse(d),e=f.properties().getOneValue("GN")||"sgf:"+b;c.sgfMapping[e]=d;c.sgfCollection=c.sgfCollection.concat(this.fromMovetree(f,e))}return c},fromMovetree:function(a,c){for(var b=[],d=[],f=a.node();f;){if(!a.properties().getOneValue("C")&&0<f.numChildren())f=a.node(),d=d.concat(this.getVariationPaths(a));else{var e=glift.rules.treepath.findNextMovesPath(a);
b.push(this.createExample(c,e.treepath,e.nextMoves));d=d.concat(this.getVariationPaths(a));for(e=0;e<d.length;e++){var g=a.getTreeFromRoot(d[e]),g=glift.rules.treepath.findNextMovesPath(g);b.push(this.createExample(c,g.treepath,g.nextMoves))}d=[]}f=f.getChild(0);a.moveDown()}return b},getVariationPaths:function(a){a=a.newTreeRef();var c=[];if(!a.node().getParent())return c;a.moveUp();for(var b=1;b<a.node().numChildren();b++){var d=a.newTreeRef();d.moveDown(b);d.recurse(function(a){a.properties().getOneValue("C")&&
c.push(a.treepathToHere())})}return c},createExample:function(a,c,b,d){d=d||glift.enums.boardRegions.ALL;if(!glift.enums.boardRegions[d])throw Error("Unknown board region: "+d);var f=glift.rules.treepath.toString;return{widgetType:"EXAMPLE",alias:a,initialPosition:f(c),nextMovesPath:f(b),boardRegion:d}}};
gpub.diagrams={types:{GOOE:"GOOE",IGO:"IGO",PDF:"PDF"},sizes:{NORMAL:"NORMAL",LARGE:"LARGE"},create:function(a,c,b,d,f){a=this.flatten(a,b,d,f);switch(c){case "GOOE":return gpub.diagrams.gooe.create(a);default:throw Error("Not currently supported: "+c);}},flatten:function(a,c,b,d){c=c||[];b=b||[];a=glift.rules.movetree.getFromSgf(a,c);return glift.flattener.flatten(a,{nextMovesTreepath:b,boardRegion:d})}};
gpub.diagrams.gooe={create:function(a,c){return gpub.diagrams.gooe.gooeStringArray(a,c).join("\n")},gooeStringArray:function(a,c){for(var b="LARGE"===c?"{\\bgoo":"{\\goo",d=gpub.diagrams.gooe.gooeBoard(a,c),b=[b],f=0,d=d.boardArray();f<d.length;f++)b.push(d[f].join(""));b.push("}");return b},gooeBoard:function(a,c){var b=glift.flattener.symbolStr,d=gpub.diagrams.gooe.symbolMap;return a.board().transform(function(a,e,g){e=b(a.base());a.mark()&&a.stone()?e=b(a.stone())+"_"+b(a.mark()):a.stone()?e=b(a.stone()):
a.mark()&&(e=b(a.mark()));g=e+"_"+c;var h="",h=d[g]?d[g]:d[e]?d[e]:d.EMPTY;a.textLabel()&&(h=h.replace("%s",a.textLabel()));return h})}};
gpub.diagrams.gooe.headers={defs:{sizeDefs:"% Size definitions;\\newdimen\\bigRaise;\\bigRaise=4.3pt;\\newdimen\\smallRaise;\\smallRaise=3.5pt;\\newdimen\\inlineRaise;\\inlineRaise=3.5pt".split(";"),bigBoardDefs:["% Big-sized board defs","\\def\\eLblBig#1{\\leavevmode\\hbox to \\goIntWd{\\hss\\raise\\bigRaise\\hbox{\\tenpointeleven{#1}}\\hss}}","\\def\\goWsLblBig#1{\\leavevmode\\setbox0=\\hbox{\\0??!}\\rlap{\\0??!}\\raise\\bigRaise\\hbox to \\wd0{\\hss\\tenpointeleven{#1}\\hss}}","\\def\\goBsLblBig#1{\\leavevmode\\setbox0=\\hbox{\\0??@}\\rlap{\\0??@}\\raise\\bigRaise\\hbox to \\wd0{\\hss\\color{white}\\tenpointeleven{#1}\\color{white}\\hss}}"],
normalBoardDefs:["% Normal-sized board defs","\\def\\eLbl#1{\\leavevmode\\hbox to \\goIntWd{\\hss\\raise\\smallRaise\\hbox{\\tenpoint{#1}}\\hss}}","\\def\\goWsLbl#1{\\leavevmode\\setbox0=\\hbox{\\0??!}\\rlap{\\0??!}\\raise\\smallRaise\\hbox to \\wd0{\\hss\\eightpointnine{#1}\\hss}}","\\def\\goBsLbl#1{\\leavevmode\\setbox0=\\hbox{\\0??@}\\rlap{\\0??@}\\raise\\smallRaise\\hbox to \\wd0{\\hss\\color{white}\\eightpointnine{#1}\\color{white}\\hss}}"]},get:function(a){var c=gpub.diagrams.gooe.headers.defs;
a=a||"cmss";return["% Gooe font definitions","\\font\\tenpoint="+a+"10","\\font\\tenpointeleven="+a+"10 at 11pt","\\font\\eightpoint="+a+"8","\\font\\eightpointnine="+a+"8 at 9pt"].concat(c.sizeDefs).concat(c.bigBoardDefs).concat(c.normalBoardDefs).join("\n")}};
gpub.diagrams.gooe.symbolMap={EMPTY:"\\eLbl{_}",TL_CORNER:"\\0??<",TR_CORNER:"\\0??>",BL_CORNER:"\\0??,",BR_CORNER:"\\0??.",TOP_EDGE:"\\0??(",BOT_EDGE:"\\0??)",LEFT_EDGE:"\\0??[",RIGHT_EDGE:"\\0??]",CENTER:"\\0??+",CENTER_STARPOINT:"\\0??*",BSTONE:"\\0??@",WSTONE:"\\0??!",BSTONE_TRIANGLE:"\\0??S",WSTONE_TRIANGLE:"\\0??s",TRIANGLE:"\\0??3",BSTONE_SQUARE:"\\0??S",WSTONE_SQUARE:"\\0??s",SQUARE:"\\0??2",BSTONE_CIRCLE:"\\0??C",WSTONE_CIRCLE:"\\0??c",CIRCLE:"\\0??1",BSTONE_XMARK:"\\0??X",WSTONE_XMARK:"\\0??x",
XMARK:"\\0??4",BSTONE_TEXTLABEL:"\\goBsLbl{%s}",WSTONE_TEXTLABEL:"\\goWsLbl{%s}",TEXTLABEL:"\\eLbl{%s}",BSTONE_TEXTLABEL_LARGE:"\\goBsLblBig{%s}",WSTONE_TEXTLABEL_LARGE:"\\goWsLblBig{%s}",TEXTLABEL_LARGE:"\\eLblBig{%s}"};gpub.diagrams.pdf={create:function(a){}};
gpub.diagrams.latex={basicHeader_:"\\documentclass[letterpaper,12pt]{memoir} \\usepackage{gooemacs} \\usepackage{color} \\usepackage{wrapfig} \\usepackage{setspace} \\usepackage{unicode} \\usepackage[margin=1in]{geometry}  \\setlength{\\parskip}{0.5em} \\setlength{\\parindent}{0pt}".split(" "),basicHeader:function(){return gpub.diagrams.latex.basicHeader_.join("\n")},diagramLabelMacros:function(){return"% Mainline Diagrams. reset at parts\n\\newcounter{GoFigure}[part]\n\\newcommand{\\gofigure}{%\n \\stepcounter{GoFigure}\n \\centerline{\\textit{Figure.\\thinspace\\arabic{GoFigure}}}\n}\n% Variation Diagrams. reset at parts.\n\\newcounter{GoDiagram}[part]\n\\newcommand{\\godiagram}{%\n \\stepcounter{GoDiagram}\n \\centerline{\\textit{Diagram.\\thinspace\\arabic{GoDiagram}}}\n}\n\\newcommand{\\subtext}[1]{\\centerline{\\textit{#1}}}\n"},
basicFooter:"\\end{document}",generateTitleDef:function(a,c,b,d){for(var f=["\\definecolor{light-gray}{gray}{0.55}","\\newcommand*{\\mainBookTitle}{\\begingroup","  \\raggedleft"],e=0;e<b.length;e++)f.push("  {\\Large "+b[e]+"} \\\\"),0===e?f.push("  \\vspace*{0.5 em}"):e<b.length-1&&f.push("  \\vspace*{0.5 em}");return f.concat(["  \\vspace*{5 em}","  {\\textcolor{light-gray}{\\Huge "+a+"}}\\\\","  \\vspace*{\\baselineskip}","  {\\small \\bfseries "+c+"}\\par","  \\vfill","  {\\Large "+d+"}\\par",
"  \\vspace*{2\\baselineskip}","\\endgroup}"]).join("\n")},startDocument:function(){return"\\begin{document}\n\n\\pagestyle{empty}\n\\mainBookTitle\n\\newpage\n\\tableofcontents\n\n\\chapterstyle{section}\n\\pagestyle{companion}\n\\makepagestyle{headings}\n\\renewcommand{\\printchapternum}{\\space}\n\\makeevenhead{headings}{\\thepage}{}{\\slshape\\leftmark}\n\\makeoddhead{headings}{\\slshape\\rightmark}{}{\\thepage}"},gameReviewDiagram:function(a,c,b){return["\n\\rule{\\textwidth}{0.5pt}\n\n\\begin{minipage}[t]{0.5\\textwidth}",
a,b,"\\end{minipage}\n\\begin{minipage}[t]{0.5\\textwidth}\n\\setlength{\\parskip}{0.5em}",c,"\\end{minipage}\n\\vfill"].join("\n")},gameReviewChapterDiagram:function(a,c,b,d){return["\\chapter{"+b+"}","{\\centering",a,"}",d,"",c,"\\vfill"].join("\n")},labelForCollisions:function(a){if(!a||"array"!==glift.util.typeOf(a)||0===a.length)return"";for(var c=[],b=0;b<a.length;b++){var d=a[b];c.push((d.color===glift.enums.states.BLACK?"Black":"White")+" "+d.mvnum+" at "+d.label)}return c.join(", ")+"."}};
