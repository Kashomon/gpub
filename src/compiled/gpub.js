/*
 GPub: A Go publishing platform, built on Glift

 @copyright Josh Hoak
 @license MIT License (see LICENSE.txt)
 --------------------------------------
*/
(function(a){var b=b||a.gpub||{};a&&(a.gpub=b)})(window);gpub.global={version:"0.1.0"};gpub.util={};gpub.util.Buffer=function(a){this._maxSize=a||1;this._buffer=[]};gpub.util.Buffer.prototype={add:function(a){null!=a&&this._buffer.push(a);return this},atCapacity:function(){return this._buffer.length>=this._maxSize},flush:function(){var a=this._buffer.slice(0);this._buffer=[];return a}};gpub.book={bookFormat:{HTML:"HTML",LATEX:"LATEX"}};gpub.book.htmlBook={create:function(a,b){}};
gpub.book.latex={generate:function(a,b,c){if(!a)throw Error("Options must be defined. Was: "+a);b=b||gpub.templates.latexBase;c=c||gpub.diagrams.diagramType.GOOE;a=glift.widgets.createNoDraw(a);b=gpub.templates.parseLatexTemplate(b);c=gpub.diagrams[glift.enums.toCamelCase(c)].latexHeaders;var d=gpub.diagrams.latex;b.setExtraPackages(c.packageDef()).setDiagramTypeDefs(c.extraDefs()).setDiagramWrapperDefs(d.diagramDefs()).setTitleDef(this.basicTitleDef("Relentless","Gu Li vs Lee Sedol",["Younggil An",
"David Ormerod","Josh Hoak"],"Go Game Guru"));c=[];for(var d=[],e=1,f=1,g=0;g<a.sgfCollection.length;g++){var h=a.loadSgfStringSync(a.getSgfObj(g)),k=glift.rules.movetree.getFromSgf(h.sgfString,h.initialPosition),n=glift.flattener.flatten(k,{nextMovesTreepath:h.nextMovesPath,boardRegion:h.boardRegion}),l=gpub.diagrams.diagramPurpose.GAME_REVIEW;n.isOnMainPath()&&(l=gpub.diagrams.diagramPurpose.GAME_REVIEW_CHAPTER);0==k.node().getNodeNum()&&0==h.nextMovesPath.length&&(l=gpub.diagrams.diagramPurpose.SECTION_INTRO);
h={};l===gpub.diagrams.diagramPurpose.SECTION_INTRO&&(h.sectionTitle=k.getTreeFromRoot().properties().getOneValue("GN")||"",h.chapterTitle="Chapter: "+e,f++,e++);l===gpub.diagrams.diagramPurpose.GAME_REVIEW_CHAPTER&&(h.chapterTitle="Chapter: "+e,e++);k=gpub.diagrams.forPurpose(n,gpub.diagrams.diagramType.GOOE,gpub.book.bookFormat.LATEX,l,h);l===gpub.diagrams.diagramPurpose.SECTION_INTRO||l===gpub.diagrams.diagramPurpose.GAME_REVIEW_CHAPTER?(c.push(gpub.book.latex.renderPage(d)),d=[],d.push(k),c.push(gpub.book.latex.renderPage(d)),
d=[]):(d.push(k),2===d.length&&(c.push(gpub.book.latex.renderPage(d)),d=[]))}return b.setContent(c.join("\n")).compile()},basicTitleDef:function(a,b,c,d){for(var e=["\\definecolor{light-gray}{gray}{0.55}","\\newcommand*{\\mainBookTitle}{\\begingroup","  \\raggedleft"],f=0;f<c.length;f++)e.push("  {\\Large "+c[f]+"} \\\\"),0===f?e.push("  \\vspace*{0.5 em}"):f<c.length-1&&e.push("  \\vspace*{0.5 em}");return e.concat(["  \\vspace*{5 em}","  {\\textcolor{light-gray}{\\Huge "+a+"}}\\\\","  \\vspace*{\\baselineskip}",
"  {\\small \\bfseries "+b+"}\\par","  \\vfill","  {\\Large "+d+"}\\par","  \\vspace*{2\\baselineskip}","\\endgroup}"]).join("\n")},renderPage:function(a){a.push("\\newpage");return a.join("\n")}};
gpub.book.manager={toBook:function(a,b){var c=[],d=glift.enums.showVariations.NEVER,e=gpub.diagrams.gooe,f=gpub.diagrams.latex,g=gpub.book.manager,h=a.bookData;c.push(f.basicHeader());c.push(e.gooeDefs());c.push(f.generateTitleDef(h.title,h.subtitle,h.authors,h.publisher));c.push("");c.push(f.diagramLabelMacros());c.push(f.startDocument());a.prepopulateCache(function(){for(var e=h.diagramsPerPage,n=1,l=1,t=1,p=0,u=a.sgfList.length;p<u;p++){var q=a.getSgfObj(p),v=q.boardRegion,r=glift.rules.treepath.parseInitPosition(q.initialPosition),
s=[];a.getSgfString(q,function(a){var b=glift.rules.movetree.getFromSgf(a.sgfString,r),f=b.onMainline();f?t++:l++;if(h.autoNumber){var m=glift.rules.treepath.findNextMovesPath(b),b=m.movetree;r=m.treepath;s=m.nextMoves}var m=glift.rules.goban.getFromMoveTree(b).goban,p=f?b.node().getNodeNum()+1:1,b=glift.bridge.flattener.flatten(b,m,v,d,s,p),m="";a.bookData.showDiagram&&(m=g.createDiagram(b,a.bookData));f=g.typesetDiagram(m,b.comment,a.bookData,b.collisions,f);!a.bookData.chapterTitle&&n<e?(c.push("\\newpage"),
n++):n=1;c.push(f)})}c.push(f.basicFooter);b(c.join("\n"))})},createDiagram:function(a,b){var c=gpub.diagrams.gooe,d=gpub.diagrams.diagramSize.NORMAL;b.chapterTitle&&(d=gpub.diagrams.diagramSize.LARGE);d=c.diagramArray(a,d);return c.diagramArrToString(d)}};
gpub.spec={specType:{PROBLEM_SET:"PROBLEM_SET",PROBLEM_BOOK:"PROBLEM_BOOK",GAME_BOOK:"GAME_BOOK"},fromSgfs:function(a,b,c){var d=gpub.spec.specType;c=c||{};var e=b||d.GAME_BOOK;b={divId:null,sgfCollection:[],sgfMapping:{},sgfDefaults:{},metadata:{specType:e}};var f=1,d=null;switch(e){case "GAME_BOOK":b.sgfDefaults.widgetType="EXAMPLE";f=1;d=function(a,b){return gpub.spec.gameBook.one(a[0].movetree,a[0].name,b)};break;case "PROBLEM_SET":b.sgfDefaults.widgetType="STANDARD_PROBLEM";f=1;d=function(a,
b){return gpub.spec.problemSet.one(a[0].movetree,a[0].name,b)};break;case "PROBLEM_BOOK":b.sgfDefaults.widgetType="EXAMPLE";d=gpub.spec.problemBook.multi;e=gpub.spec.problemBook.answerStyle;c.answerStyle=c.answerStyle||e.END_OF_SECTION;f=c.answerStyle===e.END_OF_SECTION?a.length:c.answerStyle===e.AFTER_PAGE?c.bufferSize||4:1;break;default:throw Error("Unknown spec type: "+e);}e=new gpub.util.Buffer(f);for(f=0;a&&f<a.length;f++){var g=a[f],h=glift.sgf.parse(g),k=h.properties().getOneValue("GN")||"sgf:"+
f;e.add({movetree:h,name:k});if(e.atCapacity()||f===a.length-1)b.sgfCollection=b.sgfCollection.concat(d(e.flush(),c));b.sgfMapping[k]=g}return b},createExample:function(a,b,c,d){d=d||glift.enums.boardRegions.ALL;if(!glift.enums.boardRegions[d])throw Error("Unknown board region: "+d);var e=glift.rules.treepath.toInitPathString,f=glift.rules.treepath.toFragmentString;return{widgetType:"EXAMPLE",alias:a,initialPosition:e(b),nextMovesPath:f(c),boardRegion:d}}};
gpub.spec.gameBook={one:function(a,b,c){c=[];for(var d=[],e=a.node();e;){if(!a.properties().getOneValue("C")&&0<e.numChildren())e=a.node(),d=d.concat(gpub.spec.gameBook.variationPaths(a));else{var f=glift.rules.treepath.findNextMovesPath(a);c.push(gpub.spec.createExample(b,f.treepath,f.nextMoves));d=d.concat(gpub.spec.gameBook.variationPaths(a));for(f=0;f<d.length;f++){var g=a.getTreeFromRoot(d[f]),g=glift.rules.treepath.findNextMovesPath(g);c.push(gpub.spec.createExample(b,g.treepath,g.nextMoves))}d=
[]}e=e.getChild(0);a.moveDown()}return c},variationPaths:function(a){a=a.newTreeRef();var b=[];if(!a.node().getParent())return b;a.moveUp();for(var c=1;c<a.node().numChildren();c++){var d=a.newTreeRef();d.moveDown(c);d.recurse(function(a){a.properties().getOneValue("C")&&b.push(a.treepathToHere())})}return b}};
gpub.spec.problemBook={answerStyle:{NONE:"NONE",END_OF_SECTION:"END_OF_SECTION",AFTER_PAGE:"END_OF_SECTION"},fromProblemSet:function(a){},multi:function(a,b){for(var c=b.numAnswerVars||3,d=[],e=[],f=b.region||glift.enums.boardRegions.AUTO,g=0;g<a.length;g++){var h=a[g].movetree,k=a[g].name;d.push(gpub.spec.createExample(k,[],[],f));h=gpub.spec.problemBook.variationPaths(h,c);for(g=0;g<h.length;g++)e.push(gpub.spec.createExample(k,"",anwserVars[g],f))}},variationPaths:function(a,b){var c=[];if(0===
b)return c;a.recurseFromRoot(function(a){0===a.node().numChildren()&&c.push(a.treepathToHere())});return 0>b?c:c.slice(0,b)}};gpub.spec.problemSet={one:function(a,b,c){region=c.region||glift.enums.boardRegions.AUTO;return{alias:b,widgetType:"STANDARD_PROBLEM",boardRegion:region}}};
gpub.diagrams={diagramType:{GOOE:"GOOE",IGO:"IGO",PDF:"PDF"},diagramPurpose:{SECTION_INTRO:"SECTION_INTRO",GAME_REVIEW:"GAME_REVIEW",GAME_REVIEW_CHAPTER:"GAME_REVIEW_CHAPTER",PROBLEM:"PROBLEM",PROBLEM_SOLUTION:"PROBLEM_SOLUTION"},sizes:{NORMAL:"NORMAL",LARGE:"LARGE"},forPurpose:function(a,b,c,d,e){if(!b||!gpub.diagrams.diagramType[b])throw Error("Unknown diagram type: "+b);if(!c||!gpub.book.bookFormat[c])throw Error("Unknown diagram type: "+c);if(!d||!gpub.diagrams.diagramPurpose[d])throw Error("Unknown diagram type: "+
d);e=e||{};b=gpub.diagrams.fromFlattened(a,b);var f=null;switch(c){case "LATEX":f=gpub.diagrams.latex;break;default:throw Error("Unsupported book format: "+c);}c=null;switch(d){case "GAME_REVIEW":case "GAME_REVIEW_CHAPTER":case "SECTION_INTRO":c=gpub.diagrams.constructLabel(a.collisions(),a.isOnMainPath(),a.startingMoveNum(),a.endingMoveNum());break;default:c=""}return f.typeset(b,d,a.comment(),c,a.isOnMainPath(),e)},create:function(a,b,c,d,e){a=this.flatten(a,c,d,e);return this.fromFlattened(a,b)},
flatten:function(a,b,c,d){b=b||[];c=c||[];a=glift.rules.movetree.getFromSgf(a,b);return glift.flattener.flatten(a,{nextMovesTreepath:c,boardRegion:d})},fromFlattened:function(a,b){switch(b){case "GOOE":return gpub.diagrams.gooe.create(a);default:throw Error("Not currently supported: "+b);}},constructLabel:function(a,b,c,d){var e="";b&&(b=[c],c!==d&&b.push(d),e+="("+(1<b.length?"Moves: ":"Move: ")+b.join("-")+")");if(a&&a.length){c=[];for(d=0;d<a.length;d++)b=a[d],c.push((b.color===glift.enums.states.BLACK?
"Black":"White")+" "+b.mvnum+" at "+b.label);e&&(e+="\n");e+=c.join(", ")+"."}return e}};
gpub.diagrams.gooe={create:function(a,b){return gpub.diagrams.gooe.gooeStringArray(a,b).join("\n")},gooeStringArray:function(a,b){for(var c="LARGE"===b?"{\\bgoo":"{\\goo",d=gpub.diagrams.gooe.gooeBoard(a,b),c=[c],e=0,d=d.boardArray();e<d.length;e++)c.push(d[e].join(""));c.push("}");return c},gooeBoard:function(a,b){var c=glift.flattener.symbolStr,d=gpub.diagrams.gooe.symbolMap;return a.board().transform(function(a,f,g){f=c(a.base());a.mark()&&a.stone()?f=c(a.stone())+"_"+c(a.mark()):a.stone()?f=c(a.stone()):
a.mark()&&(f=c(a.mark()));g=f+"_"+b;var h="",h=d[g]?d[g]:d[f]?d[f]:d.EMPTY;a.textLabel()&&(h=h.replace("%s",a.textLabel()));return h})}};
gpub.diagrams.gooe.latexHeaders={packageDef:function(){return"\\usepackage{gooemacs}"},defs:{sizeDefs:"% Size definitions;\\newdimen\\bigRaise;\\bigRaise=4.3pt;\\newdimen\\smallRaise;\\smallRaise=3.5pt;\\newdimen\\inlineRaise;\\inlineRaise=3.5pt".split(";"),bigBoardDefs:["% Big-sized board defs","\\def\\eLblBig#1{\\leavevmode\\hbox to \\goIntWd{\\hss\\raise\\bigRaise\\hbox{\\tenpointeleven{#1}}\\hss}}","\\def\\goWsLblBig#1{\\leavevmode\\setbox0=\\hbox{\\0??!}\\rlap{\\0??!}\\raise\\bigRaise\\hbox to \\wd0{\\hss\\tenpointeleven{#1}\\hss}}",
"\\def\\goBsLblBig#1{\\leavevmode\\setbox0=\\hbox{\\0??@}\\rlap{\\0??@}\\raise\\bigRaise\\hbox to \\wd0{\\hss\\color{white}\\tenpointeleven{#1}\\color{white}\\hss}}"],normalBoardDefs:["% Normal-sized board defs","\\def\\eLbl#1{\\leavevmode\\hbox to \\goIntWd{\\hss\\raise\\smallRaise\\hbox{\\tenpoint{#1}}\\hss}}","\\def\\goWsLbl#1{\\leavevmode\\setbox0=\\hbox{\\0??!}\\rlap{\\0??!}\\raise\\smallRaise\\hbox to \\wd0{\\hss\\eightpointnine{#1}\\hss}}","\\def\\goBsLbl#1{\\leavevmode\\setbox0=\\hbox{\\0??@}\\rlap{\\0??@}\\raise\\smallRaise\\hbox to \\wd0{\\hss\\color{white}\\eightpointnine{#1}\\color{white}\\hss}}"]},
extraDefs:function(a){var b=gpub.diagrams.gooe.latexHeaders.defs;a=a||"cmss";return["% Gooe font definitions","\\font\\tenpoint="+a+"10","\\font\\tenpointeleven="+a+"10 at 11pt","\\font\\eightpoint="+a+"8","\\font\\eightpointnine="+a+"8 at 9pt"].concat(b.sizeDefs).concat(b.bigBoardDefs).concat(b.normalBoardDefs).join("\n")}};
gpub.diagrams.gooe.symbolMap={EMPTY:"\\eLbl{_}",TL_CORNER:"\\0??<",TR_CORNER:"\\0??>",BL_CORNER:"\\0??,",BR_CORNER:"\\0??.",TOP_EDGE:"\\0??(",BOT_EDGE:"\\0??)",LEFT_EDGE:"\\0??[",RIGHT_EDGE:"\\0??]",CENTER:"\\0??+",CENTER_STARPOINT:"\\0??*",BSTONE:"\\0??@",WSTONE:"\\0??!",BSTONE_TRIANGLE:"\\0??S",WSTONE_TRIANGLE:"\\0??s",TRIANGLE:"\\0??3",BSTONE_SQUARE:"\\0??S",WSTONE_SQUARE:"\\0??s",SQUARE:"\\0??2",BSTONE_CIRCLE:"\\0??C",WSTONE_CIRCLE:"\\0??c",CIRCLE:"\\0??1",BSTONE_XMARK:"\\0??X",WSTONE_XMARK:"\\0??x",
XMARK:"\\0??4",BSTONE_TEXTLABEL:"\\goBsLbl{%s}",WSTONE_TEXTLABEL:"\\goWsLbl{%s}",TEXTLABEL:"\\eLbl{%s}",BSTONE_TEXTLABEL_LARGE:"\\goBsLblBig{%s}",WSTONE_TEXTLABEL_LARGE:"\\goWsLblBig{%s}",TEXTLABEL_LARGE:"\\eLblBig{%s}"};gpub.diagrams.igo={create:function(a){}};gpub.diagrams.pdf={create:function(a){}};
gpub.diagrams.latex={sanitize:function(a){return a.replace(/[$#}{]/g,function(a){return"\\"+a})},typeset:function(a,b,c,d,e,f){c=this.sanitize(c);var g=glift.enums.toCamelCase(b),g=gpub.diagrams.latex[g];switch(b){case "GAME_REVIEW":case "GAME_REVIEW_CHAPTER":b=e?"\\gofigure":"\\godiagram";if(d)for(d=d.split("\n"),e=0;e<d.length;e++)b+="\n\n\\subtext{"+d[e]+"}";d=b}return g(a,c,d,f)},sectionIntro:function(a,b,c,d){return["\\part{"+(d.sectionTitle||"")+"}","\\chapter{"+(d.chapterTitle||"")+"}",b].join("\n")},
gameReview:function(a,b,c){return["\n\\rule{\\textwidth}{0.5pt}\n\n\\begin{minipage}[t]{0.5\\textwidth}",a,c,"\\end{minipage}\n\\begin{minipage}[t]{0.5\\textwidth}\n\\setlength{\\parskip}{0.5em}",b,"\\end{minipage}\n\\vfill"].join("\n")},gameReviewChapter:function(a,b,c,d){return["\\chapter{"+d.chapterTitle+"}","{\\centering",a,"}",c,"",b,"\\vfill"].join("\n")}};gpub.diagrams.latex.diagramDefs=function(a){return"% Mainline Diagrams. reset at parts\n\\newcounter{GoFigure}[part]\n\\newcommand{\\gofigure}{%\n \\stepcounter{GoFigure}\n \\centerline{\\textit{Figure.\\thinspace\\arabic{GoFigure}}}\n}\n% Variation Diagrams. reset at parts.\n\\newcounter{GoDiagram}[part]\n\\newcommand{\\godiagram}{%\n \\stepcounter{GoDiagram}\n \\centerline{\\textit{Diagram.\\thinspace\\arabic{GoDiagram}}}\n}\n\\newcommand{\\subtext}[1]{\\centerline{\\textit{#1}}}\n"};
gpub.templates={};gpub.templates._Template=function(a,b){this._sections=a;this._paramMap=b;this._paramContent={}};gpub.templates._Template.prototype={compile:function(){var a=this._sections.slice(0),b;for(b in this._paramMap)a[this._paramMap[b]]=this._paramContent[b]||"";return a.join("")},hasParam:function(a){return!!this._paramMap[a]},setParam:function(a,b){if(!this._paramMap[a])throw Error("Unknown key: "+a);this._paramContent[a]=b.toString()}};gpub.templates.latexBase="\\documentclass[letterpaper,12pt]{memoir}\n\\usepackage{color}\n\\usepackage{wrapfig}\n\\usepackage{setspace}\n\\usepackage{unicode}\n\\usepackage[margin=1in]{geometry}\n%%% Define any extra packages %%%\n{{ extraPackages }}\n\n\\setlength{\\parskip}{0.5em}\n\\setlength{\\parindent}{0pt}\n\n%%% Extra defs\n% Necessary for the particular digaram type.\n{{ diagramTypeDefs }}\n\n%%% Diagram Figure defs.\n% Must expose two commands\n%  \\gofigure  (mainline diagrams)\n%  \\godiagram (variation diagrams)\n{{ diagramWrapperDefs }}\n\n%%% Define the main title %%%\n{{ mainBookTitleDef }}\n\n\\begin{document}\n\n\\pagestyle{empty}\n\\mainBookTitle\n\\newpage\n\\tableofcontents\n\n\\chapterstyle{section}\n\\pagestyle{companion}\n\\makepagestyle{headings}\n\\renewcommand{\\printchapternum}{\\space}\n\\makeevenhead{headings}{\\thepage}{}{\\slshape\\leftmark}\n\\makeoddhead{headings}{\\slshape\\rightmark}{}{\\thepage}\n\n%%% The content. %%%\n{{ content }}\n\n\\end{document}";
gpub.templates.parseLatexTemplate=function(a){var b=gpub.templates.parse(a);["extraPackages","diagramTypeDefs","diagramWrapperDefs","mainBookTitleDef","content"].forEach(function(a){if(!b.hasParam(a))throw Error("Expected template to have key: "+a);});return new gpub.templates.LatexTemplate(b)};gpub.templates.LatexTemplate=function(a){this._template=a};
gpub.templates.LatexTemplate.prototype={setExtraPackages:function(a){this._template.setParam("extraPackages",a);return this},setDiagramTypeDefs:function(a){this._template.setParam("diagramTypeDefs",a);return this},setDiagramWrapperDefs:function(a){this._template.setParam("diagramWrapperDefs",a);return this},setTitleDef:function(a){this._template.setParam("mainBookTitleDef",a);return this},setContent:function(a){this._template.setParam("content",a);return this},compile:function(){return this._template.compile()}};
gpub.templates.parse=function(a){for(var b=[],c={},d="DEFAULT",e=[],f=null,g=0,h=0;h<a.length;h++){var k=a.charAt(h);switch(d){case "DEFAULT":"{"===k?"{"===f&&(b.push(e.join("")),d="IN_PARAM",g++,e=[]):("{"===f&&e.push(f),e.push(k));break;case "IN_PARAM":"}"===k?"}"===f&&(b.push(null),d=e.join("").replace(/^\s*|\s*$/g,""),c[d]=g,g++,d="DEFAULT",e=[]):e.push(k);break;default:throw Error("Unknown state: "+d);}f=k}b.push(e.join(""));return new gpub.templates._Template(b,c)};
